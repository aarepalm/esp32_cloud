# Security Camera — Architecture

## System Diagram

```
┌──────────────────────────────────────────────────────────────────┐
│ ESP32-S3-EYE                                                      │
│                                                                   │
│  OV2640 ──► camera_hal ──► motion_detect (QVGA grayscale)        │
│                       └──► clip_writer (MJPEG/AVI + thumbnail)   │
│                              └──► sdcard (SDMMC)                  │
│                                                                   │
│  cloud_client (background FreeRTOS task)                          │
│    ├── GET API Gateway / → presigned PUT URLs                     │
│    └── PUT clip + thumbnail to S3 (32KB chunks)                  │
└────────────────────────────────────────┬─────────────────────────┘
                                         │ HTTPS
                                API Gateway HTTP API v2
                                GET /         → presign Lambda (no auth)
                                GET /list     → list Lambda (JWT auth)
                                POST /manage  → manage Lambda (JWT auth)
                                         │
                                S3 bucket: security-cam-clips-*
                                ├── clips/{DEVICE_ID}_YYYYMMDD_HHMMSS.avi
                                ├── thumbs/{DEVICE_ID}_YYYYMMDD_HHMMSS_thumb.jpg
                                └── lifecycle: delete after 30 days (keep=false tag)
                                         │
                                S3 event → notify Lambda
                                         │
                                SES → Gmail alert

┌──────────────────────────────────────────────────────────────────┐
│ Browser                                                           │
│                                                                   │
│  CloudFront (HTTPS) ──► S3 webapp bucket (OAC) ──► index.html   │
│                                                                   │
│  Cognito hosted UI → OAuth2 Authorization Code → id_token (JWT)  │
│  JWT → API Gateway GET /list → list Lambda                        │
│    Returns: [{clip_key, clip_url, thumb_url, timestamp, size_mb, │
│               kept}]                                              │
│    clip_url + thumb_url = 7-day presigned GET URLs               │
│                                                                   │
│  Thumbnail grid → click → browser GETs clip from S3             │
│  Keep / Delete buttons → POST /manage → manage Lambda            │
└──────────────────────────────────────────────────────────────────┘
```

---

## Component Table

### Lambda functions

| Lambda | Trigger | Auth | What it does |
|--------|---------|------|--------------|
| `presign` | API GW `GET /` | None | Returns presigned PUT URLs for clip + thumbnail |
| `notify` | S3 `ObjectCreated` on `clips/` | — | Tags clip `keep=false`, sends SES email |
| `list` | API GW `GET /list` | JWT (Cognito) | Lists `clips/*.avi`, pairs with `thumbs/*`, returns 7-day presigned GET URLs and keep status |
| `manage` | API GW `POST /manage` | JWT (Cognito) | Actions: `keep`, `unkeep`, `delete` |

### S3 prefixes

| Prefix | Contents | Lifecycle |
|--------|----------|-----------|
| `clips/` | `*.avi` files | Delete after 30 days if tagged `keep=false` |
| `thumbs/` | `*_thumb.jpg` files | Delete after 30 days (always, no tag filter) |

### Webapp hosting

| Component | Role |
|-----------|------|
| S3 webapp bucket | Stores rendered `index.html` — private, no public access |
| CloudFront OAC | Authenticates to S3 via SigV4; serves `index.html` over HTTPS |
| Cognito User Pool | One user per gallery viewer; hosted UI handles login |

---

## Security Architecture

### Presign endpoint (device → S3)

- `GET /` on API Gateway is unauthenticated — the device has no JWT
- Lambda generates short-lived presigned PUT URLs (15 min) scoped to the specific
  key the device requested
- Presigned URL is single-use by convention; S3 enforces expiry
- Lambda IAM role has `s3:PutObject` on the clips bucket only

### Gallery API (browser → S3)

- `GET /list` and `POST /manage` require a valid Cognito `id_token` in the
  `Authorization` header
- API Gateway JWT Authorizer validates the token against the Cognito User Pool JWKS
- Token expiry: 1 hour; Cognito hosted UI handles refresh via browser redirect
- `id_token` is stored in browser `sessionStorage` — cleared on tab close

### S3 clips bucket

- No public access; no bucket policy allowing public reads
- Device writes via presigned PUT (short-lived, scoped to one key)
- Browser reads via presigned GET (7-day, generated by list Lambda using Lambda role)
- Lambda role has scoped IAM: `s3:PutObject`, `s3:GetObject`, `s3:ListBucket`,
  `s3:DeleteObject`, `s3:GetObjectTagging`, `s3:PutObjectTagging`

### S3 webapp bucket

- Private; CloudFront uses OAC (Origin Access Control, SigV4) to read from it
- No direct S3 URL works; all access goes through CloudFront HTTPS

### Cognito

- Hosted UI serves login over HTTPS (Cognito-managed domain)
- OAuth2 Authorization Code flow; redirect URI must be the CloudFront HTTPS URL
- No API keys exposed to the browser
- No CORS wildcards — CORS on API Gateway specifies the exact CloudFront origin

---

## Data Flow — Motion Event

```
1. OV2640 outputs QVGA grayscale frame (~300 µs)
2. motion_detect computes frame-diff score
3. score > MOTION_THRESHOLD (2000) → trigger
4. camera_hal_deinit() + camera_hal_init(CAM_MODE_RECORD) [~250 ms]
5. Discard 3 frames for AE settling
6. clip_writer_begin(): create *.avi on SD, write RIFF/AVI headers
7. FPS gate loop (100 ms / frame = 10fps):
   a. camera_hal_get_frame() → JPEG
   b. First frame: save as *_thumb.jpg on SD
   c. avi_writer: append movi chunk
   Every 50 frames:
   d. camera_hal_set_mode(MOTION) → score check → set_mode(RECORD)
   e. Discard 3 frames
   Until no-motion timeout (12 s) or max 60 s
8. clip_writer_end(): patch RIFF/AVI size + idx1 index
9. queue_upload(filename) → non-blocking post to FreeRTOS queue
10. camera_hal_set_mode(CAM_MODE_MOTION)

Upload task (background):
11. GET API GW / → { clip_url, thumb_url } presigned PUT URLs
12. PUT clip (32KB chunks) → S3 clips/
13. PUT thumbnail (32KB chunks) → S3 thumbs/
14. Unlink *.avi and *_thumb.jpg from SD card

S3 event:
15. notify Lambda fires on clips/*.avi ObjectCreated
16. Tag clip keep=false
17. SES SendEmail → Gmail
```

---

## S3 Lifecycle + Keep-Tag Pattern

The lifecycle rule cannot filter on "tag absent" — only on tag present. Pattern used:

1. `notify` Lambda tags every new clip `keep=false` on upload
2. Lifecycle rule for `clips/` prefix + tag filter `keep=false` → delete after 30 days
3. Gallery "Keep" button → `manage` Lambda sets tag `keep=true` → exempt from lifecycle
4. Gallery "Unkeep" button → tag back to `keep=false` → lifecycle resumes

Thumbnails use a separate lifecycle rule (`thumbs/` prefix, no tag filter) that always
deletes after 30 days. A kept clip's thumbnail disappears at 30 days; the clip itself
and its download link remain until explicitly deleted or unkeep'd.
